---
- hosts: all
  vars_files:
    - ../../../inventory/vars_files/common_vars.yml
    - ./win_counter_gateway/counter_vars.yml
    - ../../../automatic.yml

  handlers:
    - include: ../common/crontab_handlers.yml

  tasks:
    - include: ../common/get_time.yml

    - include: ../common/before_playbook.yml

    - block:
      - include: ./win_counter_gateway/before_playbook.yml

      - include: ./win_counter_gateway/flag_checker.yml

      - include: ./win_counter_gateway/counter_collector.yml
        when: not xcounter_fetch_ok.stat.exists

      - include: ./win_counter_gateway/counter_checker.yml

      - include: ./win_counter_gateway/task_register.yml

      - include: ./win_counter_gateway/flag_checker.yml

      - include: ./win_counter_gateway/counter_freezed.yml
        when: xcounter_fetch_ok.stat.exists and not xcounter_freezed_ok.stat.exists

      - include: ./win_counter_gateway/set_status.yml

        when: not disable_counter_fetch


    - include: ../common/after_playbook.yml
